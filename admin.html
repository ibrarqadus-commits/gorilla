<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - L&M Mastermind</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        * { font-family: 'Poppins', sans-serif; }
    </style>
</head>
<body class="bg-gray-50">
    <!-- Logo positioned at top right -->
    <div class="fixed top-2 right-2 sm:top-4 sm:right-4 z-[9999] bg-white/90 backdrop-blur-sm rounded-lg p-1 sm:p-2 shadow-lg">
        <img id="siteLogo" src="assets/logo.svg" alt="Logo" class="h-10 w-auto sm:h-16 md:h-[72px]" />
    </div>

    <!-- Navigation -->
    <nav class="bg-white shadow-lg sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between items-center h-14 sm:h-16">
                <div class="flex items-center">
                    <span class="text-base sm:text-lg md:text-xl font-bold text-gray-800 px-2 sm:px-0">L&M Mastermind - Admin Panel</span>
                </div>
                <div class="flex items-center space-x-2 sm:space-x-4">
                    <a href="index.html" class="text-xs sm:text-sm text-gray-700 hover:text-[#244855] transition px-2 sm:px-0">Home</a>
                    <button onclick="logout()" class="bg-red-600 text-white px-3 sm:px-4 py-1.5 sm:py-2 rounded-lg hover:bg-red-700 transition text-xs sm:text-sm">Logout</button>
                </div>
            </div>
        </div>
    </nav>

    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-4 sm:py-6 lg:py-8">
        <h1 class="text-2xl sm:text-3xl font-bold text-gray-800 mb-4 sm:mb-6 lg:mb-8">Admin Dashboard</h1>

        <!-- Tabs Navigation -->
        <div class="border-b border-gray-200 mb-6 overflow-x-auto">
            <nav class="-mb-px flex space-x-4 sm:space-x-8">
                <button onclick="switchTab('students')" id="tab-students" class="tab-button active border-b-2 border-[#244855] py-3 sm:py-4 px-1 text-xs sm:text-sm font-medium text-[#244855] whitespace-nowrap">
                    Students
                </button>
                <button onclick="switchTab('moduleUnit')" id="tab-moduleUnit" class="tab-button border-b-2 border-transparent py-3 sm:py-4 px-1 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    Module & Unit
                </button>
                <button onclick="switchTab('videos')" id="tab-videos" class="tab-button border-b-2 border-transparent py-3 sm:py-4 px-1 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    Videos
                </button>
                <button onclick="switchTab('social')" id="tab-social" class="tab-button border-b-2 border-transparent py-3 sm:py-4 px-1 text-xs sm:text-sm font-medium text-gray-500 hover:text-gray-700 hover:border-gray-300 whitespace-nowrap">
                    Social Media
                </button>
            </nav>
        </div>

        <!-- Students Tab -->
        <div id="content-students" class="tab-content">
            <!-- Stats -->
            <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4 sm:gap-6 mb-6 sm:mb-8">
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="text-2xl sm:text-3xl font-bold text-[#244855]" id="totalStudents">0</div>
                    <div class="text-sm sm:text-base text-gray-600">Total Students</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                    <div class="text-2xl sm:text-3xl font-bold text-green-600" id="approvedStudents">0</div>
                    <div class="text-sm sm:text-base text-gray-600">Approved Students</div>
                </div>
                <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 sm:col-span-2 lg:col-span-1">
                    <div class="text-2xl sm:text-3xl font-bold text-yellow-600" id="pendingStudents">0</div>
                    <div class="text-sm sm:text-base text-gray-600">Pending Approval</div>
                </div>
            </div>

            <!-- Pending Approvals -->
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6 mb-6 sm:mb-8">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">Pending Approvals</h2>
                <div id="pendingList" class="space-y-3">
                    <p class="text-gray-500 text-sm sm:text-base">No pending approvals</p>
                </div>
            </div>

            <!-- All Students -->
            <div class="bg-white rounded-lg shadow-md p-4 sm:p-6">
                <h2 class="text-xl sm:text-2xl font-bold text-gray-800 mb-4">All Students</h2>
                <div class="overflow-x-auto -mx-4 sm:mx-0">
                    <div class="inline-block min-w-full align-middle">
                        <table class="min-w-full divide-y divide-gray-200">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Name</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Email</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Progress</th>
                                    <th class="px-3 sm:px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Actions</th>
                                </tr>
                            </thead>
                            <tbody id="studentsTable" class="bg-white divide-y divide-gray-200">
                                <!-- Dynamic rows will be inserted here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Module & Unit Selection Tab -->
        <div id="content-moduleUnit" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Module & Unit Content Management</h2>
                
                <div class="space-y-6">
                    <!-- Module Selection -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Module</label>
                        <select id="moduleSelect" onchange="loadModuleUnits()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                            <option value="">Select a module...</option>
                            <option value="1">Module 1 - Foundation & Financial Freedom Roadmap</option>
                            <option value="2">Module 2 - Market Understanding & Property Strategy</option>
                            <option value="3">Module 3 - Business Setup & Compliance Foundations</option>
                            <option value="4">Module 4 - Client Acquisition & Lettings Operations</option>
                            <option value="5">Module 5 - Property Management & Relationship Building</option>
                            <option value="6">Module 6 - End of Tenancy, Renewals & Compliance</option>
                            <option value="7">Module 7 - Scaling, Marketing & Portfolio Growth</option>
                        </select>
                    </div>


                    <!-- Unit Selection -->
                    <div id="unitSelectionArea" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Select Unit</label>
                        <select id="unitSelect" onchange="displayUnitContent()" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                            <option value="">Select a unit...</option>
                        </select>
                    </div>

                    <!-- Units Overview -->
                    <div id="unitsOverviewArea" class="hidden">
                        <div class="mt-6 flex items-center justify-between">
                            <h3 class="text-lg font-semibold text-gray-800">Units Overview</h3>
                            <div class="space-x-2 text-sm">
                                <label class="text-gray-600">Filter:</label>
                                <select id="unitsFilter" class="px-2 py-1 border border-gray-300 rounded" onchange="renderUnitsOverview()">
                                    <option value="all">All</option>
                                    <option value="missing">Missing Any</option>
                                    <option value="complete">Complete</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3 overflow-x-auto -mx-4 sm:mx-0">
                            <table class="min-w-full divide-y divide-gray-200">
                                <thead class="bg-gray-50">
                                    <tr>
                                        <th class="px-3 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Unit</th>
                                        <th class="px-3 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Video</th>
                                        <th class="px-3 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Content</th>
                                        <th class="px-3 sm:px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="unitsOverviewBody" class="bg-white divide-y divide-gray-200"></tbody>
                            </table>
                        </div>
                    </div>

                    <!-- Content Editor -->
                    <div id="contentEditorArea" class="hidden">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Unit Content</label>
                        <textarea id="unitContentEditor" rows="15" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]" placeholder="Enter unit content here..."></textarea>

                        <!-- Unit Video URL -->
                        <div class="mt-6">
                            <label class="block text-sm font-medium text-gray-700 mb-2">Unit Video URL</label>
                            <input id="unitVideoUrl" type="text" placeholder="Enter unit-specific video URL (overrides module video)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                        </div>
                        
                        <div class="mt-4 flex flex-col sm:flex-row gap-3">
                            <button onclick="saveUnitContent()" class="bg-[#244855] text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-[#1a3540] transition text-sm sm:text-base">
                                Save Content
                            </button>
                            <button onclick="saveUnitVideoUrl()" class="bg-indigo-600 text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-indigo-700 transition text-sm sm:text-base">
                                Save Unit Video
                            </button>
                            <button onclick="resetEditor()" class="bg-gray-600 text-white px-4 sm:px-6 py-2 rounded-lg hover:bg-gray-700 transition text-sm sm:text-base">
                                Reset
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Home Page Videos Tab -->
        <div id="content-videos" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Home Page Video & Content</h2>
                
                <div class="space-y-6">
                    <!-- Video 1 (Hero) -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Hero Section Video URL</label>
                        <input type="text" id="heroVideoUrl" placeholder="Enter video URL (YouTube, Vimeo, etc.)" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                        <p class="text-sm text-gray-500 mt-1">Paste the URL of the video you want to display in the hero section</p>
                    </div>

                    <!-- Video 2 URL -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Video 2 URL</label>
                        <input type="text" id="video2Url" placeholder="Enter secondary video URL" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                    </div>

                    <!-- Home Unit Content -->
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Home Unit Content</label>
                        
                        <!-- Content Editor with Preview -->
                        <div class="space-y-4">
                            <div>
                                <div class="flex items-center justify-between mb-2">
                                    <span class="text-xs text-gray-600">Paste your text here - formatting will be preserved automatically</span>
                                    <button type="button" onclick="togglePreview()" id="previewToggle" class="text-xs text-[#244855] hover:text-[#1a3540] transition">
                                        Show Preview
                                    </button>
                                </div>
                                <textarea id="homeUnitContent" rows="8" placeholder="Paste your text here with headings, formatting, and alignment - it will be preserved as-is when displayed on the home page" class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855] font-mono text-sm"></textarea>
                            </div>
                            
                            <!-- Preview Area -->
                            <div id="contentPreview" class="hidden bg-green-50 border border-green-200 rounded-lg p-6">
                                <h4 class="text-sm font-semibold text-gray-700 mb-3">Live Preview:</h4>
                                <div id="previewContent" class="prose max-w-none text-gray-700"></div>
                            </div>
                            
                            <p class="text-sm text-gray-500">
                                💡 <strong>Tip:</strong> You can paste formatted text from Word, Google Docs, or any HTML content. Headings, alignment, bold, italic, and other formatting will be preserved automatically.
                            </p>
                        </div>
                    </div>

                    <!-- Save Button -->
                    <div class="mt-6">
                        <button onclick="saveVideoSettings()" class="bg-[#244855] text-white px-6 py-2 rounded-lg hover:bg-[#1a3540] transition">
                            Save Video Settings
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Social Media Tab -->
        <div id="content-social" class="tab-content hidden">
            <div class="bg-white rounded-lg shadow-md p-6">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">Social Media Links</h2>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Site Logo (for navbar)</label>
                        <div class="flex items-center space-x-4">
                            <img id="sm_logo_preview" class="w-24 h-24 bg-gray-100 border border-gray-300 rounded flex items-center justify-center object-contain p-2" alt="Preview">
                            <div class="space-y-2">
                                <input id="sm_logo_file" type="file" accept="image/*" class="block w-full text-sm text-gray-700">
                                <input id="sm_logo_url" type="text" placeholder="or paste image URL here" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                                <div class="flex items-center space-x-2">
                                    <button onclick="saveSiteLogo()" class="bg-[#244855] text-white px-4 py-2 rounded-lg hover:bg-[#1a3540] transition">Save Logo</button>
                                    <button onclick="clearSiteLogo()" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-300 transition">Clear</button>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Logo appears in top navbar.</p>
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Profile Image (for sidebar)</label>
                        <div class="flex items-center space-x-4">
                            <img id="sm_photo_preview" class="w-24 h-24 bg-gray-100 border border-gray-300 rounded flex items-center justify-center object-contain p-2" alt="Preview">
                            <div class="space-y-2">
                                <input id="sm_photo_file" type="file" accept="image/*" class="block w-full text-sm text-gray-700">
                                <input id="sm_photo_url" type="text" placeholder="or paste image URL here" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                                <div class="flex items-center space-x-2">
                                    <button onclick="saveProfileImage()" class="bg-[#244855] text-white px-4 py-2 rounded-lg hover:bg-[#1a3540] transition">Save Image</button>
                                    <button onclick="clearProfileImage()" class="bg-gray-200 text-gray-800 px-3 py-2 rounded-lg hover:bg-gray-300 transition">Clear</button>
                                </div>
                            </div>
                        </div>
                        <p class="text-xs text-gray-500 mt-2">Profile image appears on the home page sidebar.</p>
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">YouTube URL</label>
                        <input id="sm_youtube" type="text" placeholder="https://youtube.com/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Facebook URL</label>
                        <input id="sm_facebook" type="text" placeholder="https://facebook.com/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">Instagram URL</label>
                        <input id="sm_instagram" type="text" placeholder="https://instagram.com/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                    </div>
                    <div>
                        <label class="block text-sm font-medium text-gray-700 mb-2">TikTok URL</label>
                        <input id="sm_tiktok" type="text" placeholder="https://tiktok.com/@..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                    </div>
                    <div class="md:col-span-2">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Linktree URL</label>
                        <input id="sm_linktree" type="text" placeholder="https://linktr.ee/..." class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-[#244855] focus:border-[#244855]">
                    </div>
                </div>
                <div class="mt-6">
                    <button onclick="saveSocialLinks()" class="bg-[#244855] text-white px-6 py-2 rounded-lg hover:bg-[#1a3540] transition">Save Social Links</button>
                </div>
            </div>
        </div>
    </div>

    <script src="js/main.js"></script>
    <script>
        // Render top-right logo (respects admin settings)
        (function renderTopRightLogo(){
            try {
                const logoEl = document.getElementById('siteLogo');
                if (!logoEl) return;
                const storedLogo = JSON.parse(localStorage.getItem('siteLogo')) || {};
                const profileImage = JSON.parse(localStorage.getItem('profileImage')) || {};
                const src = storedLogo.dataUrl || storedLogo.url || profileImage.dataUrl || profileImage.url;
                const defaultPng = 'assets/logo.png';
                const defaultSvg = 'assets/logo.svg';

                if (src) {
                    logoEl.src = src;
                    logoEl.onerror = function(){
                        logoEl.onerror = null;
                        logoEl.src = defaultPng;
                        logoEl.onerror = function(){ logoEl.onerror = null; logoEl.src = defaultSvg; };
                    };
                } else {
                    logoEl.src = defaultPng;
                    logoEl.onerror = function(){ logoEl.onerror = null; logoEl.src = defaultSvg; };
                }
            } catch (e) {}
        })();

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.add('hidden');
            });

            // Remove active class from all tabs
            document.querySelectorAll('.tab-button').forEach(button => {
                button.classList.remove('active', 'border-[#244855]', 'text-[#244855]');
                button.classList.add('border-transparent', 'text-gray-500');
            });

            // Show selected tab content
            document.getElementById('content-' + tabName).classList.remove('hidden');

            // Add active class to clicked tab
            const activeButton = document.getElementById('tab-' + tabName);
            activeButton.classList.add('active', 'border-[#244855]', 'text-[#244855]');
            activeButton.classList.remove('border-transparent', 'text-gray-500');
        }

        // Students functionality
        function logout() {
            localStorage.removeItem('currentUser');
            window.location.href = 'index.html';
        }

        function updateStats() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const students = users.filter(u => u.role !== 'admin');
            const approved = students.filter(s => s.approved);
            const pending = students.filter(s => !s.approved);

            document.getElementById('totalStudents').textContent = students.length;
            document.getElementById('approvedStudents').textContent = approved.length;
            document.getElementById('pendingStudents').textContent = pending.length;
        }

        function updatePendingList() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const pending = users.filter(u => u.role !== 'admin' && !u.approved);
            const container = document.getElementById('pendingList');

            if (pending.length === 0) {
                container.innerHTML = '<p class="text-gray-500">No pending approvals</p>';
                return;
            }

            container.innerHTML = pending.map(user => `
                <div class="flex flex-col sm:flex-row items-start sm:items-center justify-between p-4 border rounded-lg gap-3">
                    <div class="flex-1">
                        <div class="font-semibold text-sm sm:text-base">${user.name}</div>
                        <div class="text-xs sm:text-sm text-gray-600">${user.email}</div>
                    </div>
                    <div class="flex space-x-2 w-full sm:w-auto">
                        <button onclick="approveStudent('${user.email}')" class="flex-1 sm:flex-none bg-green-600 text-white px-3 sm:px-4 py-2 rounded hover:bg-green-700 text-sm">
                            Approve
                        </button>
                        <button onclick="rejectStudent('${user.email}')" class="flex-1 sm:flex-none bg-red-600 text-white px-3 sm:px-4 py-2 rounded hover:bg-red-700 text-sm">
                            Reject
                        </button>
                    </div>
                </div>
            `).join('');
        }

        function updateStudentsTable() {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const students = users.filter(u => u.role !== 'admin');
            const tbody = document.getElementById('studentsTable');

            if (students.length === 0) {
                tbody.innerHTML = '<tr><td colspan="5" class="px-6 py-4 text-center text-gray-500">No students yet</td></tr>';
                return;
            }

            tbody.innerHTML = students.map(user => {
                const progress = calculateOverallProgress(user);
                const statusBadge = user.approved 
                    ? '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800">Approved</span>'
                    : '<span class="px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800">Pending</span>';

                return `
                    <tr>
                        <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm font-medium text-gray-900">${user.name}</td>
                        <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">${user.email}</td>
                        <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap">${statusBadge}</td>
                        <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">
                            <div class="w-full bg-gray-200 rounded-full h-2 mb-1">
                                <div class="bg-[#244855] h-2 rounded-full" style="width: ${progress}%"></div>
                            </div>
                            <span class="text-xs">${progress}%</span>
                        </td>
                        <td class="px-3 sm:px-6 py-3 sm:py-4 whitespace-nowrap text-xs sm:text-sm text-gray-500">
                            <button onclick="viewProgress('${user.email}')" class="text-[#244855] hover:text-[#1a3540] text-xs sm:text-sm">View</button>
                        </td>
                    </tr>
                `;
            }).join('');
        }

        function calculateOverallProgress(user) {
            if (!user.progress) return 0;
            const modules = ['1', '2', '3', '4', '5', '6', '7'];
            let totalCompleted = 0;
            let totalUnits = 56;

            modules.forEach(modId => {
                if (user.progress[modId]) {
                    totalCompleted += Object.keys(user.progress[modId]).length;
                }
            });

            return Math.round((totalCompleted / totalUnits) * 100);
        }

        function approveStudent(email) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const userIndex = users.findIndex(u => u.email === email);
            
            if (userIndex !== -1) {
                users[userIndex].approved = true;
                localStorage.setItem('users', JSON.stringify(users));
                updateStats();
                updatePendingList();
                updateStudentsTable();
            }
        }

        function rejectStudent(email) {
            if (!confirm('Are you sure you want to reject this student?')) return;
            
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const filteredUsers = users.filter(u => u.email !== email);
            localStorage.setItem('users', JSON.stringify(filteredUsers));
            updateStats();
            updatePendingList();
            updateStudentsTable();
        }

        function viewProgress(email) {
            const users = JSON.parse(localStorage.getItem('users')) || [];
            const user = users.find(u => u.email === email);
            
            if (user && user.progress) {
                let progressDetails = `Progress for ${user.name}:\n\n`;
                const modules = {
                    '1': 'Foundation & Financial Freedom Roadmap',
                    '2': 'Market Understanding & Property Strategy',
                    '3': 'Business Setup & Compliance Foundations',
                    '4': 'Client Acquisition & Lettings Operations',
                    '5': 'Property Management & Relationship Building',
                    '6': 'End of Tenancy, Renewals & Compliance',
                    '7': 'Scaling, Marketing & Portfolio Growth'
                };
                
                Object.keys(modules).forEach(modId => {
                    const moduleProgress = user.progress[modId];
                    const completed = moduleProgress ? Object.keys(moduleProgress).length : 0;
                    progressDetails += `Module ${modId}: ${completed} units completed\n`;
                });
                
                alert(progressDetails);
            } else {
                alert('No progress data available for this student.');
            }
        }

        // Module & Unit functionality
        const moduleUnits = {
            '1': ['1.1', '1.2', '1.3', '1.4', '1.5', '1.6'],
            '2': ['2.1', '2.2', '2.3', '2.4', '2.5', '2.6', '2.7', '2.8', '2.9'],
            '3': ['3.1', '3.2', '3.3', '3.4', '3.5', '3.6', '3.7'],
            '4': ['4.1', '4.2', '4.3', '4.4', '4.5', '4.6', '4.7', '4.8'],
            '5': ['5.1', '5.2', '5.3', '5.4', '5.5', '5.6', '5.7', '5.8', '5.9', '5.10'],
            '6': ['6.1', '6.2', '6.3', '6.4', '6.5', '6.6', '6.7', '6.8'],
            '7': ['7.1', '7.2', '7.3', '7.4', '7.5', '7.6', '7.7', '7.8']
        };

        function loadModuleUnits() {
            const moduleId = document.getElementById('moduleSelect').value;
            const unitSelect = document.getElementById('unitSelect');
            const unitSelectionArea = document.getElementById('unitSelectionArea');
            
            if (!moduleId) {
                unitSelectionArea.classList.add('hidden');
                document.getElementById('contentEditorArea').classList.add('hidden');
                return;
            }

            unitSelectionArea.classList.remove('hidden');
            unitSelect.innerHTML = '<option value="">Select a unit...</option>';
            
            moduleUnits[moduleId].forEach(unit => {
                const option = document.createElement('option');
                option.value = moduleId + '.' + unit.split('.')[1];
                option.textContent = `Unit ${unit}`;
                unitSelect.appendChild(option);
            });

            // Show and render overview
            document.getElementById('unitsOverviewArea').classList.remove('hidden');
            renderUnitsOverview();
        }

        function displayUnitContent() {
            const moduleId = document.getElementById('moduleSelect').value;
            const unitId = document.getElementById('unitSelect').value;
            const contentEditorArea = document.getElementById('contentEditorArea');
            const editor = document.getElementById('unitContentEditor');
            const unitVideoUrlInput = document.getElementById('unitVideoUrl');

            if (!unitId) {
                contentEditorArea.classList.add('hidden');
                return;
            }

            contentEditorArea.classList.remove('hidden');
            
            // Load existing content from localStorage if available
            const customContent = JSON.parse(localStorage.getItem('moduleContent')) || {};
            const contentKey = `${moduleId}.${unitId}`;
            editor.value = customContent[contentKey] || '';

            // Load existing unit video url
            const unitVideos = JSON.parse(localStorage.getItem('unitVideos')) || {};
            unitVideoUrlInput.value = unitVideos[`${moduleId}.${unitId}`] || '';
        }

        function saveUnitContent() {
            const moduleId = document.getElementById('moduleSelect').value;
            const unitId = document.getElementById('unitSelect').value;
            const content = document.getElementById('unitContentEditor').value;

            const customContent = JSON.parse(localStorage.getItem('moduleContent')) || {};
            customContent[`${moduleId}.${unitId}`] = content;
            localStorage.setItem('moduleContent', JSON.stringify(customContent));

            alert('Content saved successfully!');
            renderUnitsOverview();
        }


        function saveUnitVideoUrl() {
            const moduleId = document.getElementById('moduleSelect').value;
            const unitId = document.getElementById('unitSelect').value;
            const url = document.getElementById('unitVideoUrl').value;
            const unitVideos = JSON.parse(localStorage.getItem('unitVideos')) || {};
            unitVideos[`${moduleId}.${unitId}`] = url;
            localStorage.setItem('unitVideos', JSON.stringify(unitVideos));
            alert('Unit video saved!');
            renderUnitsOverview();
        }

        function resetEditor() {
            document.getElementById('unitContentEditor').value = '';
        }

        // Video management functionality
        function saveVideoSettings() {
            const heroVideo = document.getElementById('heroVideoUrl').value;
            const video2 = document.getElementById('video2Url').value;
            const homeUnitContent = document.getElementById('homeUnitContent').value;

            const settings = JSON.parse(localStorage.getItem('videoSettings')) || {};
            settings.heroVideo = heroVideo;
            settings.video2 = video2;
            settings.homeUnitContent = homeUnitContent;
            localStorage.setItem('videoSettings', JSON.stringify(settings));
            alert('Video settings saved successfully!');
        }

        // User-friendly content editor with paste preservation
        function setupContentEditor() {
            const textarea = document.getElementById('homeUnitContent');
            if (!textarea) return;

            // Handle paste events to preserve HTML formatting
            textarea.addEventListener('paste', function(e) {
                e.preventDefault();
                
                // Get clipboard data
                const clipboardData = e.clipboardData || window.clipboardData;
                const pastedData = clipboardData.getData('text/html') || clipboardData.getData('text/plain');
                
                // Get current cursor position
                const start = textarea.selectionStart;
                const end = textarea.selectionEnd;
                const text = textarea.value;
                
                // Insert pasted content at cursor position
                const beforeText = text.substring(0, start);
                const afterText = text.substring(end);
                
                // If HTML was pasted, use it; otherwise use plain text
                let contentToInsert = pastedData;
                if (!clipboardData.getData('text/html')) {
                    // Plain text - convert line breaks to <br> tags
                    contentToInsert = pastedData.replace(/\n/g, '<br>');
                }
                
                // Insert content
                textarea.value = beforeText + contentToInsert + afterText;
                
                // Update cursor position
                const newPosition = start + contentToInsert.length;
                textarea.setSelectionRange(newPosition, newPosition);
                
                // Update preview if visible
                updatePreview();
            });

            // Update preview on input
            textarea.addEventListener('input', function() {
                updatePreview();
            });
        }

        function updatePreview() {
            const textarea = document.getElementById('homeUnitContent');
            const previewDiv = document.getElementById('previewContent');
            if (!textarea || !previewDiv) return;
            
            const content = textarea.value;
            // Display the HTML content (safe to use innerHTML since it's admin-only and preview)
            previewDiv.innerHTML = content || '<em class="text-gray-400">Preview will appear here...</em>';
        }

        function togglePreview() {
            const previewDiv = document.getElementById('contentPreview');
            const toggleBtn = document.getElementById('previewToggle');
            if (!previewDiv || !toggleBtn) return;
            
            const isHidden = previewDiv.classList.contains('hidden');
            if (isHidden) {
                previewDiv.classList.remove('hidden');
                toggleBtn.textContent = 'Hide Preview';
                updatePreview();
            } else {
                previewDiv.classList.add('hidden');
                toggleBtn.textContent = 'Show Preview';
            }
        }

        // Render Units Overview table
        function renderUnitsOverview() {
            const moduleId = document.getElementById('moduleSelect').value;
            if (!moduleId) return;
            const tbody = document.getElementById('unitsOverviewBody');
            const filter = (document.getElementById('unitsFilter') || {}).value || 'all';
            const customContent = JSON.parse(localStorage.getItem('moduleContent')) || {};
            const unitVideos = JSON.parse(localStorage.getItem('unitVideos')) || {};
            const rows = moduleUnits[moduleId].map(unit => {
                const uid = moduleId + '.' + unit.split('.')[1];
                const hasVideo = Boolean(unitVideos[uid]);
                const hasContent = Boolean(customContent[`${moduleId}.${uid}`] || customContent[uid]);
                return { uid, label: unit, hasVideo, hasContent };
            }).filter(row => {
                if (filter === 'missing') return !(row.hasVideo && row.hasContent);
                if (filter === 'complete') return row.hasVideo && row.hasContent;
                return true;
            });

            const badge = (ok) => ok 
                ? '<span class="px-2 py-1 text-xs rounded-full bg-green-100 text-green-700">OK</span>'
                : '<span class="px-2 py-1 text-xs rounded-full bg-red-100 text-red-700">Missing</span>';

            tbody.innerHTML = rows.map(r => `
                <tr>
                    <td class="px-3 sm:px-4 py-2 text-xs sm:text-sm text-gray-800">Unit ${r.label}</td>
                    <td class="px-3 sm:px-4 py-2">${badge(r.hasVideo)}</td>
                    <td class="px-3 sm:px-4 py-2">${badge(r.hasContent)}</td>
                    <td class="px-3 sm:px-4 py-2 text-xs sm:text-sm">
                        <div class="flex flex-wrap gap-2">
                            <button class="text-[#244855] hover:text-[#1a3540]" onclick="openUnit('${r.uid}')">Edit</button>
                            <button class="text-indigo-600 hover:text-indigo-800" title="Set Video URL" onclick="quickSetVideo('${r.uid}')">Set Video</button>
                            ${r.hasVideo ? `<button class=\"text-red-600 hover:text-red-800\" title=\"Clear Video\" onclick=\"quickClearVideo('${r.uid}')\">Clear</button>` : ''}
                        </div>
                    </td>
                </tr>
            `).join('');
        }

        function openUnit(uid) {
            // Set dropdown, show editor and load content
            const unitSelect = document.getElementById('unitSelect');
            unitSelect.value = uid;
            displayUnitContent();
            // Scroll to editor
            document.getElementById('contentEditorArea').scrollIntoView({ behavior: 'smooth', block: 'start' });
        }

        function quickSetVideo(uid) {
            const current = (JSON.parse(localStorage.getItem('unitVideos')) || {})[uid] || '';
            const url = prompt('Paste Unit Video URL', current);
            if (url === null) return; // cancelled
            const unitVideos = JSON.parse(localStorage.getItem('unitVideos')) || {};
            unitVideos[uid] = url.trim();
            localStorage.setItem('unitVideos', JSON.stringify(unitVideos));
            renderUnitsOverview();
        }

        function quickClearVideo(uid) {
            if (!confirm('Remove video URL for this unit?')) return;
            const unitVideos = JSON.parse(localStorage.getItem('unitVideos')) || {};
            delete unitVideos[uid];
            localStorage.setItem('unitVideos', JSON.stringify(unitVideos));
            renderUnitsOverview();
        }

        // Check if admin
        if (!isAdmin()) {
            alert('Access denied. Admin only.');
            window.location.href = 'index.html';
        }

        // Initialize dashboard
        updateStats();
        updatePendingList();
        updateStudentsTable();

        // Prefill video/content settings on load
        (function prefillVideoSettings(){
            try {
                const settings = JSON.parse(localStorage.getItem('videoSettings')) || {};
                if (settings.heroVideo) document.getElementById('heroVideoUrl').value = settings.heroVideo;
                if (settings.video2) document.getElementById('video2Url').value = settings.video2;
                if (settings.homeUnitContent) document.getElementById('homeUnitContent').value = settings.homeUnitContent;
                
                // Setup content editor after values are loaded
                setupContentEditor();
            } catch (e) {}
        })();

        // Load Social Links when Social tab opens initially
        loadSocialLinks();

        // Load logo preview initially
        (function initLogoPreview(){
            const stored = JSON.parse(localStorage.getItem('siteLogo')) || {};
            const img = document.getElementById('sm_logo_preview');
            if (img && (stored.dataUrl || stored.url)) {
                img.src = stored.dataUrl || stored.url;
            }
            const fileInput = document.getElementById('sm_logo_file');
            if (fileInput) {
                fileInput.addEventListener('change', function(e){
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(ev){
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
            const urlInput = document.getElementById('sm_logo_url');
            if (urlInput) {
                urlInput.addEventListener('input', function(e){
                    const v = e.target.value.trim();
                    if (v) img.src = v;
                });
            }
        })();

        // Load photo preview initially
        (function initPhotoPreview(){
            const stored = JSON.parse(localStorage.getItem('profileImage')) || {};
            const img = document.getElementById('sm_photo_preview');
            if (img && (stored.dataUrl || stored.url)) {
                img.src = stored.dataUrl || stored.url;
            }
            const fileInput = document.getElementById('sm_photo_file');
            if (fileInput) {
                fileInput.addEventListener('change', function(e){
                    const file = e.target.files && e.target.files[0];
                    if (!file) return;
                    const reader = new FileReader();
                    reader.onload = function(ev){
                        img.src = ev.target.result;
                    };
                    reader.readAsDataURL(file);
                });
            }
            const urlInput = document.getElementById('sm_photo_url');
            if (urlInput) {
                urlInput.addEventListener('input', function(e){
                    const v = e.target.value.trim();
                    if (v) img.src = v;
                });
            }
        })();

        function saveSocialLinks() {
            const payload = {
                youtube: document.getElementById('sm_youtube').value,
                facebook: document.getElementById('sm_facebook').value,
                instagram: document.getElementById('sm_instagram').value,
                tiktok: document.getElementById('sm_tiktok').value,
                linktree: document.getElementById('sm_linktree').value
            };
            localStorage.setItem('socialLinks', JSON.stringify(payload));
            alert('Social links saved!');
        }

        function loadSocialLinks() {
            const stored = JSON.parse(localStorage.getItem('socialLinks')) || {};
            const set = (id, v) => { const el = document.getElementById(id); if (el) el.value = v || ''; };
            set('sm_youtube', stored.youtube);
            set('sm_facebook', stored.facebook);
            set('sm_instagram', stored.instagram);
            set('sm_tiktok', stored.tiktok);
            set('sm_linktree', stored.linktree);
        }

        function saveProfileImage() {
            const imgUrl = document.getElementById('sm_photo_url').value;
            const fileInput = document.getElementById('sm_photo_file');
            const file = fileInput && fileInput.files && fileInput.files[0];
            const persist = (data) => {
                try {
                    localStorage.setItem('profileImage', JSON.stringify(data));
                    alert('Profile image saved!');
                } catch (e) {
                    alert('Could not save image. It may be too large for local storage. Please use a smaller image or a URL.');
                }
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev){
                    const dataUrl = ev.target.result;
                    // Downscale large images before saving
                    const img = new Image();
                    img.onload = function(){
                        try {
                            const maxDim = 512;
                            let { width, height } = img;
                            if (width > maxDim || height > maxDim) {
                                const scale = Math.min(maxDim / width, maxDim / height);
                                width = Math.round(width * scale);
                                height = Math.round(height * scale);
                            }
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            const mime = (dataUrl && dataUrl.startsWith('data:image/png')) ? 'image/png' : 'image/jpeg';
                            const output = canvas.toDataURL(mime, 0.9);
                            persist({ dataUrl: output, url: '' });
                        } catch (e) {
                            // Fallback to original data URL if canvas fails
                            persist({ dataUrl, url: '' });
                        }
                    };
                    img.onerror = function(){
                        persist({ dataUrl, url: '' });
                    };
                    img.src = dataUrl;
                };
                reader.readAsDataURL(file);
                return;
            }
            if (imgUrl) {
                persist({ dataUrl: '', url: imgUrl });
                return;
            }
            alert('Please choose a file or paste an image URL.');
        }

        function saveSiteLogo() {
            const imgUrl = document.getElementById('sm_logo_url').value;
            const fileInput = document.getElementById('sm_logo_file');
            const file = fileInput && fileInput.files && fileInput.files[0];
            const persist = (data) => {
                try {
                    localStorage.setItem('siteLogo', JSON.stringify(data));
                    const preview = document.getElementById('sm_logo_preview');
                    if (preview) preview.src = data.dataUrl || data.url || '';
                    alert('Logo saved!');
                } catch (e) {
                    alert('Could not save logo. It may be too large for local storage. Please use a smaller image or a URL.');
                }
            };
            if (file) {
                const reader = new FileReader();
                reader.onload = function(ev){
                    const dataUrl = ev.target.result;
                    // Downscale large images before saving
                    const img = new Image();
                    img.onload = function(){
                        try {
                            const maxDim = 512;
                            let { width, height } = img;
                            if (width > maxDim || height > maxDim) {
                                const scale = Math.min(maxDim / width, maxDim / height);
                                width = Math.round(width * scale);
                                height = Math.round(height * scale);
                            }
                            const canvas = document.createElement('canvas');
                            canvas.width = width;
                            canvas.height = height;
                            const ctx = canvas.getContext('2d');
                            ctx.drawImage(img, 0, 0, width, height);
                            const mime = (dataUrl && dataUrl.startsWith('data:image/png')) ? 'image/png' : 'image/jpeg';
                            const output = canvas.toDataURL(mime, 0.9);
                            persist({ dataUrl: output, url: '' });
                        } catch (e) {
                            // Fallback to original data URL if canvas fails
                            persist({ dataUrl, url: '' });
                        }
                    };
                    img.onerror = function(){
                        persist({ dataUrl, url: '' });
                    };
                    img.src = dataUrl;
                };
                reader.readAsDataURL(file);
                return;
            }
            if (imgUrl) {
                persist({ dataUrl: '', url: imgUrl });
                return;
            }
            alert('Please choose a logo file or paste an image URL.');
        }

        function clearSiteLogo() {
            localStorage.removeItem('siteLogo');
            const preview = document.getElementById('sm_logo_preview');
            if (preview) preview.src = '';
            alert('Logo cleared.');
        }

        function clearProfileImage() {
            localStorage.removeItem('profileImage');
            const preview = document.getElementById('sm_photo_preview');
            if (preview) preview.src = '';
            alert('Profile image cleared.');
        }
    </script>
</body>
</html>
